<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация - Столовая Л2Ш</title>
    <link rel="stylesheet" href="/css/cafeteria_styles.css">
</head>
<body>
    <div class="container" style="max-width: 500px; margin-top: 5vh;">
        <h1>Регистрация и вход</h1>

        <form id="registerForm">
            <input type="text" id="name" placeholder="Имя" required>
            <input type="text" id="secondary_name" placeholder="Фамилия" required>
            <input type="email" id="email" placeholder="Почта" required>
            <!-- Пароль удалён: установка пароля происходит на /verify -->

            <!-- Добавлена кнопка отправки -->
            <button type="submit" id="regBtn">Создать аккаунт</button>
        </form>

        <a id="toggleText" style="color: var(--accent-cyan); text-decoration: none;" href="/register_login/login">
            Уже есть аккаунт? <br>Войти можно тут.
        </a>
    </div>

    <script src="/js/script.js"></script>
    <script>
        // Function to update button text based on input fields
        function updateButtonText() {
            const nameInput = document.getElementById('name');
            const secondaryNameInput = document.getElementById('secondary_name');
            const regBtn = document.getElementById('regBtn');

            if (!regBtn) return;

            // Check if any of the required fields are empty
            if (nameInput.value.trim() === '' || secondaryNameInput.value.trim() === '') {
                regBtn.textContent = 'Войти';
            } else {
                regBtn.textContent = 'Зарегистрироваться';
            }
        }

        // Add event listeners to input fields to update button text dynamically
        document.getElementById('name').addEventListener('input', updateButtonText);
        document.getElementById('secondary_name').addEventListener('input', updateButtonText);

        // Set initial button text based on current field values
        updateButtonText();

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('regBtn');
            btn.disabled = true;
            const name = document.getElementById('name').value.trim();
            const secondary_name = document.getElementById('secondary_name').value.trim();
            const email = document.getElementById('email').value.trim();
            const status = document.getElementById('status')?.value.trim() || "active";

            // Validate required fields
            if (!name || !secondary_name || !email) {
                alert('Пожалуйста, заполните имя, фамилию и почту.');
                btn.disabled = false;
                return;
            }

            const data = {
                name,
                secondary_name,
                email,
                status
            };


            try {
                const resp = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json().catch(() => ({}));

                if (resp.ok || resp.status === 201) {
                    // Успешная регистрация или переотправка кода
                    localStorage.setItem('pending_email', email);
                    window.location.href = '/register_login/verify';
                    return;
                } else if (result.detail) {
                    alert('Ошибка регистрации: ' + result.detail);
                    console.log(result);
                } else {
                    alert('Ошибка регистрации. Проверьте данные.');
                    console.log('Registration failed', resp.status, result);
                }
            } catch (err) {
                alert('Ошибка соединения с сервером.');
                console.error('Ошибка:', err);
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>