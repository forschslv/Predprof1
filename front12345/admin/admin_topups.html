<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Пополнения баланса - Админ</title>
    <link rel="stylesheet" href="/cafeteria_styles.css">
</head>
<body>
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Пополнения баланса — просмотр и одобрение</h1>
            <button onclick="window.location.href='/admin/admin.html'" class="secondary" style="width:auto;">Назад в панель</button>
        </div>
        <div class="inventory-item">
            <h3>Изменить статус пополнения вручную</h3>
            <input type="number" id="topupIdInp" placeholder="ID пополнения">
            <select id="newTopupStatus">
                <option value="PAID">Оплачено (PAID)</option>
                <option value="ON_REVIEW">На проверке (ON_REVIEW)</option>
                <option value="PENDING">Ожидает (PENDING)</option>
                <option value="REJECTED">Отклонено (REJECTED)</option>
            </select>
            <input type="number" id="paidAmountInp" placeholder="Сумма для начисления (необязательно)" style="margin-top:8px;">
            <button onclick="updateTopupStatus()">Сменить статус</button>
        </div>

        <div class="inventory-item">
            <h3>Просмотр квитанции (PDF/изображения)</h3>
            <input type="number" id="pdfTopupId" placeholder="ID пополнения">
            <button onclick="viewTopupProof()">Просмотреть квитанцию</button>
            <div style="margin-top: 20px;">
                <iframe id="pdfViewer" width="100%" height="600px" style="border: 1px solid #ccc; display: none;"></iframe>
                <img id="imageViewer" style="max-width: 100%; max-height: 600px; border: 1px solid #ccc; display: none;">
                <button id="downloadProofBtn" class="btn" style="display: none; margin-top: 10px;">Скачать квитанцию</button>
            </div>
        </div>

        <div class="inventory-item">
            <h3>Получить ID пополнений по статусу</h3>
            <select id="statusFilter">
                <option value="PAID">Оплачено (PAID)</option>
                <option value="ON_REVIEW">На проверке (ON_REVIEW)</option>
                <option value="PENDING">Ожидает (PENDING)</option>
                <option value="REJECTED">Отклонено (REJECTED)</option>
            </select>
            <button onclick="loadTopupIdsByStatus()">Загрузить ID</button>
            <div id="topupIdsResult" class="order-ids-result" style="display: none;">
                <h4>ID пополнений:</h4>
                <ul id="topupIdsList"></ul>
            </div>
        </div>

    </div>

    <script src="/script.js"></script>
    <script>
        checkAuth(); requireAdmin();
    </script>
    <script>
        // Установим reportDate только если элемент реально присутствует (в старых версиях формы его могло не быть)
        (function(){
            const rd = document.getElementById('reportDate');
            if (rd) rd.value = new Date().toISOString().split('T')[0];
        })();

        async function downloadDocx() {
            const rd = document.getElementById('reportDate');
            const date = rd ? rd.value : new Date().toISOString().split('T')[0];
            await downloadFile(`/admin/reports/docx?date_query=${date}`, `Topups_Report_${date}.docx`);
        }

        // Загрузка списка пополнений для админа
        async function loadTopups() {
            const container = document.getElementById('topupsList');
            container.innerHTML = 'Загрузка...';
            try {
                let resp = await apiRequest('/admin/balance/topups_all', 'GET');
                if (!Array.isArray(resp)) resp = [];
                if (resp.length === 0) {
                    container.innerHTML = '<p>Заявок нет</p>';
                    return;
                }

                const listEl = document.createElement('div');
                resp.forEach(t => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'topup-item';
                    wrapper.style = 'padding:10px;border:1px solid var(--border-color);margin-bottom:10px;border-radius:6px;background:var(--surface-color);';

                    const info = document.createElement('div');
                    info.innerHTML = `<b>ID:</b> ${t.id} &nbsp; <b>Пользователь:</b> ${t.user_id} &nbsp; <b>Сумма:</b> ${t.amount} &nbsp; <b>Статус:</b> ${t.status} &nbsp; <b>Дата:</b> ${new Date(t.created_at).toLocaleString()}`;

                    const btns = document.createElement('div');
                    btns.style = 'margin-top:8px;';

                    const viewBtn = document.createElement('button');
                    viewBtn.textContent = 'Просмотреть квитанцию';
                    viewBtn.onclick = () => { document.getElementById('pdfTopupId').value = t.id; viewTopupProof(); };

                    const approveBtn = document.createElement('button');
                    approveBtn.textContent = 'Зачислить средства (PAID)';
                    approveBtn.style = 'margin-left:8px;';
                    approveBtn.onclick = async () => {
                        if (!confirm(`Пометить пополнение ${t.id} как PAID и начислить ${t.amount}?`)) return;
                        await apiRequest(`/admin/balance/topups/${t.id}/status?status=PAID&amount=${t.amount}`, 'PATCH');
                        alert('Статус изменён');
                        loadTopups();
                    };

                    const rejectBtn = document.createElement('button');
                    rejectBtn.textContent = 'Отклонить';
                    rejectBtn.style = 'margin-left:8px;';
                    rejectBtn.onclick = async () => {
                        if (!confirm(`Отклонить пополнение ${t.id}?`)) return;
                        await apiRequest(`/admin/balance/topups/${t.id}/status?status=REJECTED`, 'PATCH');
                        alert('Статус изменён');
                        loadTopups();
                    };

                    btns.appendChild(viewBtn);
                    btns.appendChild(approveBtn);
                    btns.appendChild(rejectBtn);

                    wrapper.appendChild(info);
                    wrapper.appendChild(btns);
                    listEl.appendChild(wrapper);
                });
                container.innerHTML = '';
                container.appendChild(listEl);
            } catch (e) {
                container.innerHTML = '<p>Ошибка загрузки: ' + (e.message || e) + '</p>';
            }
        }

        // Делаем previousBlobUrl глобальным через window, чтобы не попадать в TDZ при inline-обработчиках
        window.previousBlobUrl = window.previousBlobUrl || null;
        async function viewTopupProof() {
            const topupIdEl = document.getElementById('pdfTopupId');
            const topupId = topupIdEl ? topupIdEl.value : null;
            if (!topupId) return alert("Введите ID пополнения");
            const token = localStorage.getItem('token');
            const url = `${API_URL}/balance/topups/${topupId}/proof`;
            const iframe = document.getElementById('pdfViewer');
            const imageViewer = document.getElementById('imageViewer');
            const downloadBtn = document.getElementById('downloadProofBtn');
            if (iframe) iframe.style.display = 'none';
            if (imageViewer) imageViewer.style.display = 'none';
            if (downloadBtn) downloadBtn.style.display = 'none';
            if (window.previousBlobUrl) { window.URL.revokeObjectURL(window.previousBlobUrl); window.previousBlobUrl = null; }
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || "Квитанция не найдена");
                }
                const contentType = response.headers.get('content-type');
                const blob = await response.blob();
                const isPdf = (contentType && contentType.includes('application/pdf')) || blob.type.includes('pdf');
                const isImage = (contentType && (
                    contentType.includes('image/jpeg') ||
                    contentType.includes('image/jpg') ||
                    contentType.includes('image/png') ||
                    contentType.includes('image/bmp') ||
                    contentType.includes('image/webp')
                )) || (
                    blob.type.includes('jpeg') ||
                    blob.type.includes('jpg') ||
                    blob.type.includes('png') ||
                    blob.type.includes('bmp') ||
                    blob.type.includes('webp')
                );
                if (isPdf) {
                    const blobUrl = window.URL.createObjectURL(blob);
                    window.previousBlobUrl = blobUrl;
                    if (iframe) {
                        iframe.src = blobUrl;
                        iframe.style.display = 'block';
                    }
                    if (downloadBtn) {
                        downloadBtn.style.display = 'inline-block';
                        downloadBtn.onclick = () => {
                            const a = document.createElement('a');
                            a.href = blobUrl;
                            a.download = `topup_${topupId}.pdf`;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                        };
                    }
                } else if (isImage) {
                    const blobUrl = window.URL.createObjectURL(blob);
                    window.previousBlobUrl = blobUrl;
                    if (imageViewer) {
                        imageViewer.src = blobUrl;
                        imageViewer.style.display = 'block';
                    }
                    if (downloadBtn) {
                        downloadBtn.style.display = 'inline-block';
                        downloadBtn.onclick = () => {
                            const a = document.createElement('a');
                            a.href = blobUrl;
                            a.download = `topup_${topupId}.${blob.type.split('/')[1] || 'img'}`;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                        };
                    }
                } else {
                    throw new Error("Файл не является PDF или разрешённым изображением (JPEG, PNG, BMP, WEBP) и не может быть отображён.");
                }
            } catch (e) {
                alert("Ошибка: " + e.message);
            }
        }

        async function updateTopupStatus() {
            const id = document.getElementById('topupIdInp').value;
            const status = document.getElementById('newTopupStatus').value;
            const amount = document.getElementById('paidAmountInp').value;
            if (!id) return alert('Введите ID пополнения');
            // Подтверждение: при PAID это начисление баланса пользователю
            if (status === 'PAID') {
                const confirmMsg = amount ? `Вы уверены, что хотите перевести пополнение ${id} в PAID и начислить ${amount}?` : `Вы уверены, что хотите перевести пополнение ${id} в PAID и начислить сумму, указанную в заявке?`;
                if (!confirm(confirmMsg)) return;
            }
            let url = `/admin/balance/topups/${id}/status?status=${status}`;
            if (status === 'PAID' && amount) url += `&amount=${amount}`;
            await apiRequest(url, 'PATCH');
            alert('Статус изменён');
        }

        async function loadTopupIdsByStatus() {
            const status = document.getElementById('statusFilter').value;
            try {
                // В проекте нет специального эндпоинта /admin/balance/topups/ids — используем полный список и фильтруем на клиенте
                let resp = await apiRequest('/admin/balance/topups_all', 'GET');
                if (!Array.isArray(resp)) resp = [];
                const filtered = resp.filter(t => t.status === status).map(t => t.id);
                const listElement = document.getElementById('topupIdsList');
                const resultDiv = document.getElementById('topupIdsResult');
                listElement.innerHTML = '';
                if (filtered.length === 0) {
                    listElement.innerHTML = '<li>Нет пополнений с выбранным статусом</li>';
                } else {
                    filtered.forEach(id => {
                        const li = document.createElement('li');
                        li.textContent = id;
                        listElement.appendChild(li);
                    });
                }
                resultDiv.style.display = 'block';
            } catch (error) {
                alert('Ошибка загрузки ID пополнений: ' + error.message);
            }
        }
</script>
</body>
</html>