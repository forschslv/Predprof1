<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход - Столовая Л2Ш</title>
    <link rel="stylesheet" href="cafeteria_styles.css">
</head>
<body>
    <div class="container" style="max-width: 450px; margin-top: 10vh;">
        <h1>Вход в систему</h1>
        <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
            Введите ваш лицейский Email для получения кода
        </p>

        <form id="loginForm">
            <input type="email" id="email" placeholder="email@students.sch2.ru" required>
            <button type="submit" id="submitBtn">Получить код входа</button>
        </form>

        <div id="toggleText">
            <a href="index.html" style="color: var(--accent-cyan); text-decoration: none;">Нет аккаунта? Зарегистрироваться</a>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const btn = document.getElementById('submitBtn');

            // Предварительная проверка домена
            if (!email.endsWith("@students.sch2.ru")) {
                alert("Ошибка: Разрешена только почта @students.sch2.ru");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Отправка...";

            try {
                // В main.py /register принимает UserCreate.
                // Для логина существующего юзера поля name/status не обновятся, но они обязательны в схеме.
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: "Login",
                        secondary_name: "Request",
                        status: "Existing",
                        email: email
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Если 201 (Registered или Code resent)
                    localStorage.setItem('pending_email', email);
                    window.location.href = 'verify.html';
                } else {
                    // Если 400 (например, ошибка домена) или 422
                    alert("Ошибка: " + (result.detail || "Не удалось отправить код"));
                    btn.disabled = false;
                    btn.innerText = "Получить код входа";
                }
            } catch (err) {
                alert("Сетевая ошибка. Проверьте подключение к серверу.");
                btn.disabled = false;
                btn.innerText = "Получить код входа";
            }
        });
    </script>
</body>
</html>