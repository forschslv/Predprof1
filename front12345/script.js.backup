// Backup of script.js before modifying API_URL
const API_URL = 'http://localhost:8000';

function apiRequest(endpoint, method = 'GET', body = null, isFileUpload = false) {
    const url = API_URL + endpoint;
    const headers = {};
    let requestBody = body;

    if (!isFileUpload) {
        headers['Content-Type'] = 'application/json';
        if (body) requestBody = JSON.stringify(body);
    }

    const token = localStorage.getItem('token');
    if (token) headers['Authorization'] = `Bearer ${token}`;

    const options = {
        method,
        headers
    };
    if (requestBody) options.body = requestBody;

    return fetch(url, options).then(async res => {
        const text = await res.text();
        if (!res.ok) {
            let errorMsg = text;
            try {
                const json = JSON.parse(text);
                errorMsg = json.detail || json.message || text;
            } catch {}
            throw new Error(errorMsg);
        }
        try {
            return JSON.parse(text);
        } catch {
            return text;
        }
    });
}

function downloadFile(endpoint, filename) {
    const url = API_URL + endpoint;
    const token = localStorage.getItem('token');
    const headers = {};
    if (token) headers['Authorization'] = `Bearer ${token}`;
    return fetch(url, { headers })
        .then(res => {
            if (!res.ok) throw new Error('File download failed');
            return res.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });
}

function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = 'login.html';
}

function checkAuth() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return false;
    }
    return true;
}

function requireAdmin() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!user.is_admin) {
        alert('Требуются права администратора');
        window.location.href = 'dashboard.html';
        return false;
    }
    return true;
}

function validateAccess() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!user.is_admin) {
        window.location.href = 'dashboard.html';
        return false;
    }
    return true;
}

function checkAvailability() {
    return fetch(API_URL + '/menu').then(res => res.ok).catch(() => false);
}