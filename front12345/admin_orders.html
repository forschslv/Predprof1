<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Заказы - Админ</title>
    <link rel="stylesheet" href="cafeteria_styles.css">
</head>
<body>
    <div class="container">
        <h1>Проверка оплат и отчеты</h1>

        <div class="stats-box">
            <h3>Скачать ведомость для столовой (DOCX)</h3>
            <input type="date" id="reportDate">
            <button onclick="downloadDocx()">Скачать Report.docx</button>
        </div>

        <div class="inventory-item">
            <h3>Изменить статус заказа вручную</h3>
            <input type="number" id="orderIdInp" placeholder="ID заказа">
            <select id="newStatus">
                <option value="PAID">Оплачено (PAID)</option>
                <option value="PROBLEM">Проблема (PROBLEM)</option>
                <option value="PENDING">Ожидает (PENDING)</option>
                <option value="CANCELED">Отменён (CANCELED)</option>
                <option value="ON_REVIEW">На проверке (ON_REVIEW)</option>
            </select>
            <button onclick="updateStatus()">Сменить статус</button>
        </div>

        <div class="inventory-item">
            <h3>Просмотр чека (PDF)</h3>
            <input type="number" id="pdfOrderId" placeholder="ID заказа">
            <button onclick="viewReceipt()">Просмотреть чек</button>
            <div style="margin-top: 20px;">
                <iframe id="pdfViewer" width="100%" height="600px" style="border: 1px solid #ccc; display: none;"></iframe>
                <button id="downloadReceiptBtn" class="btn" style="display: none; margin-top: 10px;">Скачать чек</button>
            </div>
        </div>
        <button onclick="window.location.href='admin.html'" class="secondary">Назад</button>
    </div>

    <script src="script.js"></script>
    <script>
        checkAuth(); requireAdmin();
    </script>
    <script>        document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];

        async function downloadDocx() {
            const date = document.getElementById('reportDate').value;
            downloadFile(`/admin/reports/docx?date_query=${date}`, `Table_Report_${date}.docx`);
        }

        async function updateStatus() {
            const id = document.getElementById('orderIdInp').value;
            const status = document.getElementById('newStatus').value;
            await apiRequest(`/admin/orders/${id}/status?status=${status}`, 'PATCH');
            alert("Статус изменен");
        }

        async function viewReceipt() {
            const orderId = document.getElementById('pdfOrderId').value;
            if (!orderId) return alert("Введите ID заказа");
            const token = localStorage.getItem('token');
            const url = `${API_URL}/orders/${orderId}/receipt`;
            const iframe = document.getElementById('pdfViewer');
            const downloadBtn = document.getElementById('downloadReceiptBtn');
            // Скрыть iframe и кнопку скачивания перед новым запросом
            iframe.style.display = 'none';
            if (downloadBtn) downloadBtn.style.display = 'none';
            try {
                // Проверим, доступен ли файл
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || "Чек не найден");
                }
                // Установить src для iframe
                iframe.src = url + '?token=' + encodeURIComponent(token);
                iframe.style.display = 'block';
                // Показать кнопку скачивания
                if (downloadBtn) {
                    downloadBtn.style.display = 'inline-block';
                    downloadBtn.onclick = () => {
                        const a = document.createElement('a');
                        a.href = url + '?token=' + encodeURIComponent(token);
                        a.download = `receipt_${orderId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    };
                }
            } catch (e) {
                alert("Ошибка: " + e.message);
            }
        }
</script>
</body>
</html>