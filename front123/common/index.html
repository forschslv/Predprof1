<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–µ–Ω—é - –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–∞ –ø–∏—Ç–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="../cafeteria_styles.css">
</head>

<body>
<div class="container">
    <h1>–ú–µ–Ω—é üçΩÔ∏è</h1>

    <div id="menuSection">
        <h2>–ì–ª–æ–±–∞–ª—å–Ω–æ–µ –º–µ–Ω—é</h2>
        <div class="filter-section">
            <select id="dishTypeFilter">
                <option value="">–í—Å–µ —Ç–∏–ø—ã –±–ª—é–¥</option>
                <option value="MAIN">–í—Ç–æ—Ä–æ–µ –≥–æ—Ä—è—á–µ–µ –±–ª—é–¥–æ</option>
                <option value="GARNISH">–ì–∞—Ä–Ω–∏—Ä</option>
                <option value="PREPARED">–ì–æ—Ç–æ–≤–æ–µ –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–µ –±–ª—é–¥–æ</option>
                <option value="DRINK">–ù–∞–ø–∏—Ç–æ–∫</option>
                <option value="SALAD">–°–∞–ª–∞—Ç</option>
                <option value="SOUP">–°—É–ø</option>
                <option value="BREAD">–•–ª–µ–±</option>
            </select>
            <button onclick="filterDishes()">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
        </div>
        
        <div id="dishesList">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –±–ª—é–¥...</p>
        </div>
    </div>

    <div id="moduleMenuSection">
        <h2>–ú–µ–Ω—é –Ω–∞ –º–æ–¥—É–ª—å</h2>
        <div id="weekMenuDisplay">
            <div class="week-menu">
                <div class="week-day-container">
                    <div class="week-day-title">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</div>
                    <div id="day-0-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="week-day-container">
                    <div class="week-day-title">–í—Ç–æ—Ä–Ω–∏–∫</div>
                    <div id="day-1-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="week-day-container">
                    <div class="week-day-title">–°—Ä–µ–¥–∞</div>
                    <div class="week-day-title">–°—Ä–µ–¥–∞</div>
                    <div id="day-2-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="week-day-container">
                    <div class="week-day-title">–ß–µ—Ç–≤–µ—Ä–≥</div>
                    <div id="day-3-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="week-day-container">
                    <div class="week-day-title">–ü—è—Ç–Ω–∏—Ü–∞</div>
                    <div id="day-4-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div class="week-day-container">
                    <div class="week-day-title">–°—É–±–±–æ—Ç–∞</div>
                    <div id="day-5-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="navigation-links">
        <a href="../index.html"><button class="secondary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button></a>
        <a href="../auth/index.html"><button class="secondary">–í–æ–π—Ç–∏</button></a>
        <a href="../orders/index.html"><button class="secondary">–ö –∑–∞–∫–∞–∑–∞–º</button></a>
        <a href="../admin/index.html"><button class="secondary">–ö –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</button></a>
    </div>
</div>

<script>
    // Global variables
    try {
        const API_BASE = "http://localhost:8000";
    } catch (e) {
        console.error("Error initializing API_BASE:", e);
    }
    let currentToken = localStorage.getItem('token');
    let currentUser = null;
    let globalMenu = [];

    // Load user data if available
    if (currentToken) {
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
        }
    }

    // Initialize the app
    window.addEventListener('DOMContentLoaded', async () => {
        await loadGlobalMenu();
        await loadModuleMenu();
    });

    async function loadGlobalMenu() {
        try {
            const response = await fetch(`${API_BASE}/menu`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });
            
            if (response.ok) {
                globalMenu = await response.json();
                displayDishes(globalMenu);
            } else {
                globalMenu = [];
                displayDishes([]);
            }
        } catch (error) {
            console.error("Error loading global menu:", error);
            globalMenu = [];
            displayDishes([]);
        }
    }

    function displayDishes(dishes) {
        const dishesList = document.getElementById('dishesList');
        
        if (!dishesList) return;
        
        if (dishes.length === 0) {
            dishesList.innerHTML = '<p>–ú–µ–Ω—é –ø—É—Å—Ç–æ</p>';
            return;
        }
        
        let dishesHtml = '';
        dishes.forEach(dish => {
            dishesHtml += `
                <div class="menu-item">
                    <div>
                        <b>${dish.name}</b> (${getDishTypeName(dish.type)})
                        <br><small><strong>–°–æ—Å—Ç–∞–≤:</strong> ${dish.composition}</small>
                        <br><small><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${dish.quantity_grams} –≥—Ä–∞–º–º</small>
                        <br><small><strong>–¶–µ–Ω–∞:</strong> ${dish.price_rub}‚ÇΩ</small>
                    </div>
                </div>
            `;
        });
        
        dishesList.innerHTML = dishesHtml;
    }

    function getDishTypeName(type) {
        const typeNames = {
            'MAIN': '–í—Ç–æ—Ä–æ–µ –≥–æ—Ä—è—á–µ–µ –±–ª—é–¥–æ',
            'GARNISH': '–ì–∞—Ä–Ω–∏—Ä',
            'PREPARED': '–ì–æ—Ç–æ–≤–æ–µ –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–µ –±–ª—é–¥–æ',
            'DRINK': '–ù–∞–ø–∏—Ç–æ–∫',
            'SALAD': '–°–∞–ª–∞—Ç',
            'SOUP': '–°—É–ø',
            'BREAD': '–•–ª–µ–±'
        };
        return typeNames[type] || type;
    }

    function filterDishes() {
        const filterValue = document.getElementById('dishTypeFilter').value;
        
        if (!filterValue) {
            displayDishes(globalMenu);
        } else {
            const filteredDishes = globalMenu.filter(dish => dish.type === filterValue);
            displayDishes(filteredDishes);
        }
    }

    async function loadModuleMenu() {
        try {
            const response = await fetch(`${API_BASE}/module-menu`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });
            
            if (response.ok) {
                const moduleMenu = await response.json();
                
                // Load dishes for each day that has them
                for (let i = 0; i < 6; i++) {
                    const dayDishes = moduleMenu[i];
                    if (dayDishes && dayDishes.dish_ids && dayDishes.dish_ids.length > 0) {
                        loadDishesForDayDisplay(i, dayDishes.dish_ids);
                    }
                }
            } else {
                console.error("Error loading module menu:", response.statusText);
            }
        } catch (error) {
            console.error("Error loading module menu:", error);
        }
    }

    async function loadDishesForDayDisplay(dayIndex, dishIds) {
        try {
            const promises = dishIds.map(dishId => 
                fetch(`${API_BASE}/menu/${dishId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                }).then(res => res.json())
            );
            
            const dishes = await Promise.all(promises);
            
            const dayContainer = document.getElementById(`day-${dayIndex}-dishes`);
            if (!dayContainer) return;
            
            let dishesHtml = '';
            
            dishes.forEach(dish => {
                if (dish) {
                    dishesHtml += `
                        <div class="dish-item">
                            <div class="dish-info">
                                <div class="dish-name">${dish.name}</div>
                                <div class="dish-composition">${dish.composition}</div>
                                <div class="dish-type">${getDishTypeName(dish.type)}</div>
                            </div>
                            <div class="dish-price">${dish.price_rub}‚ÇΩ</div>
                        </div>
                    `;
                }
            });
            
            dayContainer.innerHTML = dishesHtml || '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–ª—é–¥</p>';
        } catch (error) {
            console.error(`Error loading dishes for day ${dayIndex}:`, error);
            const container = document.getElementById(`day-${dayIndex}-dishes`);
            if (container) container.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥</p>';
        }
    }
</script>

</body>
</html>