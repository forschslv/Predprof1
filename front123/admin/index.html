<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ - –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–∞ –ø–∏—Ç–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="../cafeteria_styles.css">
</head>

<body>
<div class="container">
    <h1>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ üìä</h1>

    <div id="adminSection">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h2>
        <div id="ordersManagement">
            <div id="ordersList">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
            </div>
        </div>
        
        <h2>–û—Ç—á–µ—Ç—ã</h2>
        <div class="filter-section">
            <label>–î–∞—Ç–∞: <input type="date" id="reportDate"></label>
            <button onclick="downloadReport()" class="secondary">–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</button>
        </div>
    </div>

    <div class="navigation-links">
        <a href="../index.html"><button class="secondary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button></a>
        <a href="../auth/index.html"><button class="secondary">–í–æ–π—Ç–∏</button></a>
        <a href="../common/index.html"><button class="secondary">–ö –º–µ–Ω—é</button></a>
        <a href="../orders/index.html"><button class="secondary">–ö –∑–∞–∫–∞–∑–∞–º</button></a>
    </div>
</div>

<script>
    // Global variables
    try {
        const API_BASE = "http://localhost:8000";
    } catch (e) {
        console.error("Error initializing API_BASE:", e);
    }
    let currentToken = localStorage.getItem('token');
    let currentUser = null;

    // Load user data if available
    if (currentToken) {
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
        }
    }

    // Initialize the app
    window.addEventListener('DOMContentLoaded', async () => {
        await loadOrders();
    });

    async function loadOrders() {
        try {
            const response = await fetch(`${API_BASE}/orders`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });
            
            if (response.ok) {
                const orders = await response.json();
                const ordersList = document.getElementById('ordersList');
                
                if (!ordersList) return;
                
                if (orders.length === 0) {
                    ordersList.innerHTML = '<p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>';
                    return;
                }
                
                let ordersHtml = '';
                orders.forEach(order => {
                    ordersHtml += `
                        <div class="order-item">
                            <div>
                                <b>–ó–∞–∫–∞–∑ #${order.id}</b> - –°—Ç–∞—Ç—É—Å: ${order.status}
                                <br><small>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${order.user_email || 'N/A'}</small>
                                <br><small>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏: ${order.week_start_date}</small>
                                <br><small>–û–±—â–∞—è —Å—É–º–º–∞: ${order.total_amount}‚ÇΩ</small>
                            </div>
                            <div>
                                <select id="status-${order.id}">
                                    <option value="PENDING" ${order.status === 'PENDING' ? 'selected' : ''}>–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                                    <option value="PAID" ${order.status === 'PAID' ? 'selected' : ''}>–û–ø–ª–∞—á–µ–Ω</option>
                                    <option value="PROBLEM" ${order.status === 'PROBLEM' ? 'selected' : ''}>–ü—Ä–æ–±–ª–µ–º–∞</option>
                                </select>
                                <button type="button" onclick="updateOrderStatus(${order.id})" style="width:auto; margin-top:5px;">–û–±–Ω–æ–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                });
                
                ordersList.innerHTML = ordersHtml;
            } else {
                const ordersList = document.getElementById('ordersList');
                if (ordersList) {
                    ordersList.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</p>';
                }
            }
        } catch (error) {
            console.error("Error loading orders:", error);
            const ordersList = document.getElementById('ordersList');
            if (ordersList) {
                ordersList.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</p>';
            }
        }
    }

    async function updateOrderStatus(orderId) {
        const newStatus = document.getElementById(`status-${orderId}`).value;
        
        try {
            // Fixed endpoint according to OpenAPI spec
            const response = await fetch(`${API_BASE}/admin/orders/${orderId}/status?status=${newStatus}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });
            
            if (response.ok) {
                alert("–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                loadOrders(); // Refresh the list
            } else {
                const result = await response.json();
                alert(result.detail || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞");
            }
        } catch (error) {
            alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞: " + error.message);
        }
    }

    function downloadReport() {
        const reportDate = document.getElementById('reportDate').value;
        
        if (!reportDate) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –æ—Ç—á–µ—Ç–∞");
            return;
        }
        
        // Fixed endpoint according to OpenAPI spec
        window.open(`${API_BASE}/admin/reports/docx?date_query=${reportDate}`, '_blank');
    }
</script>

</body>
</html>