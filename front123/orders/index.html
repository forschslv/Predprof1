<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ó–∞–∫–∞–∑—ã - –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–∞ –ø–∏—Ç–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="../cafeteria_styles.css">
</head>

<body>
<div class="container">
    <h1>–ó–∞–∫–∞–∑—ã üìã</h1>

    <div id="ordersSection">
        <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
        <div id="myOrders">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
        </div>
    </div>

    <div id="orderFormSection">
        <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</h2>
        <div id="moduleMenuDisplay">
            <div id="weekMenuDisplay">
                <div class="week-menu">
                    <div class="week-day-container">
                        <div class="week-day-title">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</div>
                        <div id="day-0-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="week-day-container">
                        <div class="week-day-title">–í—Ç–æ—Ä–Ω–∏–∫</div>
                        <div id="day-1-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="week-day-container">
                        <div class="week-day-title">–°—Ä–µ–¥–∞</div>
                        <div id="day-2-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="week-day-container">
                        <div class="week-day-title">–ß–µ—Ç–≤–µ—Ä–≥</div>
                        <div id="day-3-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="week-day-container">
                        <div class="week-day-title">–ü—è—Ç–Ω–∏—Ü–∞</div>
                        <div id="day-4-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="week-day-container">
                        <div class="week-day-title">–°—É–±–±–æ—Ç–∞</div>
                        <div id="day-5-dishes">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            </div>
            
            <h3>–ó–∞–∫–∞–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é</h3>
            <div id="orderForm">
                <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏: <input type="date" id="weekStartDate"></label>
                <div id="weekOrderForm">
                    <!-- Day order forms will be dynamically generated -->
                </div>
                <button onclick="submitOrder()" class="secondary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>

    <div class="navigation-links">
        <a href="../index.html"><button class="secondary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button></a>
        <a href="../auth/auth.html"><button class="secondary">–í–æ–π—Ç–∏</button></a>
        <a href="../common/index.html"><button class="secondary">–ö –º–µ–Ω—é</button></a>
        <a href="../admin/index.html"><button class="secondary">–ö –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</button></a>
    </div>
</div>

<!-- Modal for Payment -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('paymentModal')">&times;</span>
        <h3>–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h3>
        <div id="paymentInfo">
            <p>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: <span id="totalOrderAmount" class="price">0‚ÇΩ</span></p>
            <p>–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã: [—Ä–µ–∫–≤–∏–∑–∏—Ç—ã]</p>
        </div>
        <div>
            <label>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã:</label>
            <input type="file" id="paymentProof" accept=".pdf,.png,.jpg,.jpeg">
        </div>
        <button onclick="confirmPayment()">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –æ–ø–ª–∞—Ç—É</button>
    </div>
</div>

<script>
    // Global variables
    try {
        const API_BASE = "http://localhost:8000";
    } catch (e) {
        console.error("Error initializing API_BASE:", e);
    }
    let currentToken = localStorage.getItem('token');
    let currentUser = null;
    let moduleMenu = {};

    // Load user data if available
    if (currentToken) {
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
        }
    }

    // Initialize the app
    window.addEventListener('DOMContentLoaded', async () => {
        await loadMyOrders();
        await loadModuleMenu();
    });

    async function loadMyOrders() {
        try {
            const response = await fetch(`${API_BASE}/orders`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });
            
            if (response.ok) {
                const orders = await response.json();
                const ordersContainer = document.getElementById('myOrders');
                
                if (!ordersContainer) return;
                
                if (orders.length === 0) {
                    ordersContainer.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>';
                    return;
                }
                
                let ordersHtml = '';
                orders.forEach(order => {
                    ordersHtml += `
                        <div class="order-item">
                            <div>
                                <b>–ó–∞–∫–∞–∑ #${order.id}</b> - –°—Ç–∞—Ç—É—Å: ${order.status}
                               <br><small>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏: ${order.week_start_date}</small>
                                <br><small>–û–±—â–∞—è —Å—É–º–º–∞: ${order.total_amount}‚ÇΩ</small>
                            </div>
                        </div>
                    `;
                });
                
                ordersContainer.innerHTML = ordersHtml;
            } else {
               const ordersContainer = document.getElementById('myOrders');
               if (ordersContainer) {
                   ordersContainer.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</p>';
               }
            }
        } catch (error) {
            console.error("Error loading orders:", error);
            const ordersContainer = document.getElementById('myOrders');
            if (ordersContainer) {
                ordersContainer.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</p>';
            }
        }
    }

    async function loadModuleMenu() {
        try {
            const response = await fetch(`${API_BASE}/module-menu`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
               }
            });
            
            if (response.ok) {
                moduleMenu = await response.json();
            } else {
                // If no module menu exists yet, create an empty one
                moduleMenu = {};
            }
            
            displayModuleMenu();
            setupOrderForm();
        } catch (error) {
            console.error("Error loading module menu:", error);
            // Create empty module menu
            moduleMenu = {};
            displayModuleMenu();
            setupOrderForm();
        }
    }

    function displayModuleMenu() {
        const daysOfWeek = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
        
        // Now load dishes for each day that has them
        for (let i = 0; i < 6; i++) {
            const dayDishes = moduleMenu[i];
            if (dayDishes && dayDishes.dish_ids && dayDishes.dish_ids.length > 0) {
                loadDishesForDayDisplay(i, dayDishes.dish_ids);
            }
        }
    }

    async function loadDishesForDayDisplay(dayIndex, dishIds) {
        try {
            const promises = dishIds.map(dishId => 
                fetch(`${API_BASE}/menu/${dishId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                }).then(res => res.json())
            );
            
            const dishes = await Promise.all(promises);
            
            const dayContainer = document.getElementById(`day-${dayIndex}-dishes`);
            if (!dayContainer) return;
            
            let dishesHtml = '';
            
            dishes.forEach((dish, idx) => {
                if (dish) {
                    dishesHtml += `
                        <div class="dish-item">
                            <div class="dish-info">
                                <div class="dish-name">${dish.name}</div>
                                <div class="dish-composition">${dish.composition}</div>
                                <div class="dish-type">${getDishTypeName(dish.type)}</div>
                            </div>
                            <div class="dish-price">${dish.price_rub}‚ÇΩ</div>
                        </div>
                    `;
                }
            });
            
            dayContainer.innerHTML = dishesHtml || '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–ª—é–¥</p>';
        } catch (error) {
           console.error(`Error loading dishes for day ${dayIndex}:`, error);
            const container = document.getElementById(`day-${dayIndex}-dishes`);
            if (container) container.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥</p>';
        }
    }

    function getDishTypeName(type) {
        const typeNames = {
            'MAIN': '–í—Ç–æ—Ä–æ–µ –≥–æ—Ä—è—á–µ–µ –±–ª—é–¥–æ',
            'GARNISH': '–ì–∞—Ä–Ω–∏—Ä',
            'PREPARED': '–ì–æ—Ç–æ–≤–æ–µ –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–µ –±–ª—é–¥–æ',
            'DRINK': '–ù–∞–ø–∏—Ç–æ–∫',
            'SALAD': '–°–∞–ª–∞—Ç',
            'SOUP': '–°—É–ø',
            'BREAD': '–•–ª–µ–±'
        };
        return typeNames[type] || type;
    }

    function setupOrderForm() {
        const weekOrderForm = document.getElementById('weekOrderForm');
        if (!weekOrderForm) return;
        
        const daysOfWeek = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
        
        let formHtml = '';
        
        for (let i = 0; i < 6; i++){
            const dayDishes = moduleMenu[i] || { dish_ids: [] };
            formHtml += `
                <div class="week-day-container">
                    <div class="week-day-title">${daysOfWeek[i]}</div>
                    <div id="day-${i}-order-form">
                        ${dayDishes.dish_ids && dayDishes.dish_ids.length > 0 
                            ? '<p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–∫–∞–∑–∞...</p>' 
                            : '<p>–ù–µ—Ç –º–µ–Ω—é –¥–ª—è –∑–∞–∫–∞–∑–∞ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å</p>'
                        }
                    </div>
                    <div class="day-total">
                        –ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å: <span id="day-${i}-total" class="price">0‚ÇΩ</span>
                   </div>
                </div>
            `;
        }
        
        weekOrderForm.innerHTML = formHtml;
        
        // Now populate order forms for each day that has dishes
        for (let i = 0; i < 6; i++) {
            const dayDishes = moduleMenu[i];
            if (dayDishes && dayDishes.dish_ids && dayDishes.dish_ids.length > 0) {
                setupDayOrderForm(i, dayDishes.dish_ids);
            }
        }
    }

    async function setupDayOrderForm(dayIndex, dishIds) {
        try {
            const promises = dishIds.map(dishId => 
                fetch(`${API_BASE}/menu/${dishId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                }).then(res => res.json())
            );
            
            const dishes = await Promise.all(promises);
            
            const dayFormContainer = document.getElementById(`day-${dayIndex}-order-form`);
            if (!dayFormContainer) return;
            
            let formHtml = '';
            
            dishes.forEach((dish, dishIdx) => {
                if (dish) {
                    formHtml += `
                        <div class="dish-item">
                            <div class="dish-info">
                                <div class="dish-name">${dish.name}</div>
                                <div class="dish-composition">${dish.composition}</div>
                                <div class="dish-type">${getDishTypeName(dish.type)}</div>
                            </div>
                            <div>
                                <button type="button" onclick="adjustQuantity(${dayIndex}, ${dish.id}, -1)">-</button>
                                <input type="number" id="qty-${dayIndex}-${dish.id}" class="order-quantity" value="0" min="0" onchange="updateDayTotal(${dayIndex})">
                                <button type="button" onclick="adjustQuantity(${dayIndex}, ${dish.id}, 1)">+</button>
                                <div class="dish-price">${dish.price_rub}‚ÇΩ</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            dayFormContainer.innerHTML = formHtml;
        } catch (error) {
            console.error(`Error setting up order form for day ${dayIndex}:`, error);
            const container = document.getElementById(`day-${dayIndex}-order-form`);
            if (container) container.innerHTML = '<p>–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º—ã –∑–∞–∫–∞–∑–∞</p>';
        }
    }

    function adjustQuantity(dayIndex, dishId, change) {
        const qtyInput = document.getElementById(`qty-${dayIndex}-${dishId}`);
        if (!qtyInput) return;
        
        let newValue = parseInt(qtyInput.value) + change;
        
        if (newValue < 0) newValue = 0;
        
        qtyInput.value = newValue;
    }

    function updateDayTotal(dayIndex) {
        // This function would update the day total
    }

    async function submitOrder() {
        const weekStartDate = document.getElementById('weekStartDate').value;
        
        if (!weekStartDate) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏");
            return;
        }
        
        // Prepare order data
        const orderData = {
            week_start_date: weekStartDate,
            days: []
        };
        
        for (let dayIndex = 0; dayIndex < 6; dayIndex++) {
            const dishIds = moduleMenu[dayIndex]?.dish_ids || [];
            const dayItems = [];
            
            dishIds.forEach(dishId => {
                const qtyInput = document.getElementById(`qty-${dayIndex}-${dishId}`);
                if (qtyInput) {
                    const quantity = parseInt(qtyInput.value) || 0;
                    if (quantity > 0) {
                        dayItems.push({
                            dish_id: dishId,
                            quantity: quantity
                        });
                    }
                }
            });
            
            if (dayItems.length > 0) {
                orderData.days.push({
                    day_of_week: dayIndex,
                    items: dayItems
                });
            }
        }
        
        if (orderData.days.length === 0){
           alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –±–ª—é–¥–æ –≤ –∑–∞–∫–∞–∑");
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                },
                body: JSON.stringify(orderData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                alert(`–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${result.id}, –æ–±—â–∞—è —Å—É–º–º–∞: ${result.total_amount}‚ÇΩ`);
                
                // Show payment modal
                const totalAmountElement = document.getElementById('totalOrderAmount');
                if (totalAmountElement) {
                    totalAmountElement.textContent = `${result.total_amount}‚ÇΩ`;
                }
                document.getElementById('paymentModal').style.display = 'block';
            } else {
                alert(result.detail || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞");
            }
        } catch (error) {
            alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞: " + error.message);
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    async function confirmPayment() {
        const orderId = 1; // In a real app, this would come from the created order
        const paymentProof = document.getElementById('paymentProof').files[0];
        
        if (!paymentProof) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã");
            return;
        }
        
        // In a real app, we would upload the payment proof file
        // For now, we'll just show a success message
        alert("–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!");
        closeModal('paymentModal');
        
        // Reload orders
        await loadMyOrders();
    }
</script>

</body>
</html>