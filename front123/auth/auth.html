<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è - –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–∞ –ø–∏—Ç–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="../cafeteria_styles.css">
</head>

<body>
<div class="container">
    <h1>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è üçΩÔ∏è</h1>

    <div id="authSection">
        <h2 id="authTitle">–í—Ö–æ–¥</h2>
        <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="hidden">
        <input type="email" id="email" placeholder="Email">
        <input type="text" id="confirmCode" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
        
        <button onclick="handleAuth()" id="authBtn">–í–æ–π—Ç–∏</button>
        <p onclick="toggleReg()" id="toggleText">
            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </p>
    </div>

    <div class="navigation-links">
        <a href="../index.html"><button class="secondary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button></a>
        <a href="../orders/index.html"><button class="secondary">–ö –∑–∞–∫–∞–∑–∞–º</button></a>
        <a href="../common/index.html"><button class="secondary">–ö –º–µ–Ω—é</button></a>
    </div>
</div>

<script>
    // Global variables
    try {
        const API_BASE = "http://localhost:8000";
    } catch (e) {
        console.error("Error initializing API_BASE:", e);
    }
    let currentToken = localStorage.getItem('token');
    let currentRole = localStorage.getItem('role');
    let currentUser = null;
    let isRegister = false;

    // Initialize the app
    if (currentToken) {
        // Load user data from localStorage
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
        }
        // Redirect to main page if already logged in
        window.location.href = '../index.html';
    } else {
        // Set up login form by default
        const usernameField = document.getElementById('username');
        const confirmCodeField = document.getElementById('confirmCode');
        
        if (usernameField) usernameField.classList.add('hidden');
        if (confirmCodeField) confirmCodeField.classList.remove('hidden');
    }

    async function toggleReg() {
        isRegister = !isRegister;
        
        const authTitle = document.getElementById('authTitle');
        const authBtn = document.getElementById('authBtn');
        const toggleText = document.getElementById('toggleText');
        const usernameField = document.getElementById('username');
        const emailField = document.getElementById('email');
        const confirmCodeField = document.getElementById('confirmCode');
        
        if (authTitle) authTitle.innerText = isRegister ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥";
        if (authBtn) authBtn.innerText = isRegister ? "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è" : "–í–æ–π—Ç–∏";
        if (toggleText) toggleText.innerText = isRegister ? "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏" : "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è";
        
        if (!usernameField || !emailField || !confirmCodeField) {
            console.warn('Required auth elements not found');
            return;
        }
        
        if (isRegister) {
            // Registration: show username, email, and code fields
            usernameField.classList.remove('hidden');
            emailField.classList.remove('hidden');
            confirmCodeField.classList.remove('hidden');
            usernameField.placeholder = "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
        } else {
            // Login: show email and code fields
            usernameField.classList.add('hidden');
            emailField.classList.remove('hidden');
            confirmCodeField.classList.remove('hidden');
        }
    }

    async function handleAuth() {
        const username = document.getElementById('username')?.value || '';
        const email = document.getElementById('email')?.value || '';
        const confirmCode = document.getElementById('confirmCode')?.value || '';
        
        // If code field is filled, try to verify directly
        if (confirmCode.trim() !== "") {
            // Verify the code directly
            try {
                const verifyRes = await fetch(`${API_BASE}/verify-code`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, code: confirmCode })
                });
                
                const verifyData = await verifyRes.json();
                
                if (verifyRes.ok) {
                    localStorage.setItem('token', verifyData.access_token);
                    window.currentToken = verifyData.access_token;
                    window.currentUser = verifyData.user;
                    localStorage.setItem('currentUser', JSON.stringify(verifyData.user)); // Store user in localStorage
                    
                    // Determine role based on status
                    if (window.currentUser.status.toLowerCase().includes('admin')) {
                        window.currentRole = 'admin';
                    } else if (window.currentUser.status.toLowerCase().includes('cook')) {
                        window.currentRole = 'cook';
                    } else {
                        window.currentRole = 'student';
                    }
                    localStorage.setItem('role', window.currentRole);
                    
                    // Redirect to main page
                    window.location.href = '../index.html';
                } else {
                    alert(verifyData.detail || "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è");
                }
            } catch (error) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞: " + error.message);
            }
        } else {
            // Request code to be sent
            try {
                if (isRegister) {
                    // Registration flow - send verification code
                    const registerRes = await fetch(`${API_BASE}/register`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            name: username,
                            secondary_name: "User",
                            email: email,
                            status: "student"
                        })
                    });
                    
                    const registerData = await registerRes.json();
                    
                    if (registerRes.ok) {
                        alert("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ.");
                    } else {
                        alert(registerData.detail || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
                    }
                } else {
                    // Login flow - request verification code
                    const loginRes = await fetch(`${API_BASE}/register`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            name: "temp", // Not used for login
                            secondary_name: "temp",
                            email: email,
                            status: "login" // Indicate this is a login attempt
                        })
                    });
                    
                    const loginData = await loginRes.json();
                    
                    if (loginRes.ok) {
                        alert("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ.");
                    } else {
                        alert(loginData.detail || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
                    }
                }
            } catch (error) {
                if (isRegister) {
                    alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + error.message);
                } else {
                    alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
                }
            }
        }
    }
</script>

</body>
</html>