# Исправление функции регистрации с паролем

## Проблема
Функция регистрации пароля не работала корректно из-за нескольких проблем:
1. Ошибка отступа в функции `send_verification_email` в main.py
2. Неправильное получение пароля из `user_data` (использовался `getattr` вместо прямого доступа)
3. Отсутствие эндпоинта для установки пароля после регистрации
4. Отсутствие UI для установки пароля в процессе верификации

## Решение

### 1. Исправления в main.py

#### Исправление отступа в send_verification_email
```python
# Было:
def send_verification_email(to_email: str, code: str) -> None:
        print(f"--- EMAIL SIMULATION (No Credentials): Code for {to_email} is {code} ---")

# Стало:
def send_verification_email(to_email: str, code: str) -> None:
    print(f"--- EMAIL SIMULATION (No Credentials): Code for {to_email} is {code} ---")
```

#### Упрощение получения пароля в register
```python
# Было:
try:
    provided_password = getattr(user_data, 'password', None)
    if provided_password and provided_password.strip():
        password_hash = get_password_hash(provided_password)
except Exception:
    pass

# Стало:
if user_data.password:
    password_hash = get_password_hash(user_data.password)
```

#### Добавлен новый эндпоинт `/set-password`
```python
@app.post("/set-password", response_model=UserResponse)
def set_password(
    password_data: SetPasswordRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Установка пароля для текущего пользователя"""
    if password_data.password != password_data.password_confirm:
        raise HTTPException(status_code=400, detail="Пароли не совпадают")
    
    if len(password_data.password) < 6:
        raise HTTPException(status_code=400, detail="Пароль должен быть не менее 6 символов")
    
    current_user.password_hash = get_password_hash(password_data.password)
    db.commit()
    db.refresh(current_user)
    return UserResponse.model_validate(current_user)
```

### 2. Исправления в schemas.py

#### Добавлена новая схема SetPasswordRequest
```python
class SetPasswordRequest(BaseModel):
    password: str
    password_confirm: str
```

### 3. Исправления в HTML/JavaScript

#### register.html
- Исправлена обработка пароля при регистрации
- Добавлена валидация пароля (обрезание значения `.trim()`)
- Правильно передается пароль только если он не пустой

#### verify.html
- Полностью переработана страница верификации
- Добавлен раздел для установки пароля после верификации кода
- Система проверяет, установил ли пользователь пароль при регистрации
- Если нет, предлагает установить пароль перед входом в систему
- Добавлена опция пропуска установки пароля

#### profile.html
- Добавлен раздел "Безопасность" с кнопкой "Установить/Изменить пароль"
- Добавлена форма для изменения пароля в профиле пользователя

#### profile.js
- Добавлена функция `setPassword()` для отправки нового пароля на сервер
- Добавлены обработчики для кнопок управления паролем

## Процесс входа и регистрации

### Регистрация с паролем
1. Пользователь заполняет форму регистрации (имя, фамилия, email, пароль)
2. Система отправляет данные на эндпоинт `/register` с паролем
3. Сервер хеширует пароль и сохраняет его в БД
4. Пользователь получает код верификации по почте
5. Пользователь вводит код верификации

### Верификация
1. Если пароль был установлен при регистрации, пользователь сразу входит в систему
2. Если пароль НЕ был установлен, система предлагает установить его
3. После установки пароля или пропуска этого шага пользователь входит в систему

### Логин с паролем
1. Пользователь вводит email и пароль
2. Система проверяет наличие `password_hash` в БД
3. Если пароль установлен, проверяется его корректность
4. Если все OK, пользователь получает токен доступа

### Установка пароля в профиле
1. Пользователь может нажать кнопку "Установить/Изменить пароль" в профиле
2. Вводит новый пароль дважды для подтверждения
3. Система отправляет запрос на эндпоинт `/set-password` с токеном
4. Пароль обновляется в БД

## Ограничения bcrypt
- Максимальная длина пароля: 72 байта
- Система автоматически обрезает пароль до 72 символов перед хешированием
- Это изменение была в функции `get_password_hash()` и `verify_password()`

## Тестирование

### Сценарий 1: Регистрация с паролем
```
1. Перейти на /register_login/register
2. Заполнить форму: имя, фамилия, email, пароль (минимум 6 символов)
3. Нажать "Создать аккаунт"
4. На странице верификации ввести код из консоли
5. Система должна перенаправить на /main или /admin
```

### Сценарий 2: Регистрация без пароля
```
1. Перейти на /register_login/register
2. Заполнить форму БЕЗ пароля
3. Нажать "Создать аккаунт"
4. На странице верификации ввести код
5. Система должна предложить установить пароль
6. После установки или пропуска - вход в систему
```

### Сценарий 3: Логин с паролем
```
1. Перейти на /register_login/login
2. Ввести email и пароль
3. Нажать "Войти"
4. Система должна перенаправить на /main или /admin
```

### Сценарий 4: Изменение пароля в профиле
```
1. Войти в систему
2. Перейти в профиль
3. Нажать "Установить/Изменить пароль"
4. Ввести новый пароль дважды
5. Нажать "Сохранить пароль"
6. Пароль должен быть обновлен
```

